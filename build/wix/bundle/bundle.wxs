<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <!-- Get version from the embedded MSI -->
  <?define VersionNumber="!(bind.packageVersion.MainPackage)" ?>

  <!-- NEVER changer Upgrade Code otherwise you will have upgrade troubles -->
  <?define UpgradeCode="EC95672A-1A9D-489D-9283-E6B1CAA15F29" ?>

  <Bundle Name="!(loc.ApplicationName)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerFullName)" UpgradeCode="$(var.UpgradeCode)">

    <?if $(var.Platform) = x64 ?>
      <bal:Condition
        Message="#(loc.x86VersionRequired)">
        VersionNT64
      </bal:Condition>
     <?endif ?>

    <!-- checking for 32bits vcredist installation -->
    <util:RegistrySearch Id="vcredist32search"
                         Variable="vcredist32installed"
                         Root="HKLM"
                         Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x86"
                         Value="Installed"
                         Result="exists"
                         Win64="no" />

    <!-- checking for 64bits vcredist installation -->
    <util:RegistrySearch Id="vcredist64search"
                         Variable="vcredist64installed"
                         Root="HKLM"
                         Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64"
                         Value="Installed"
                         Result="exists"
                         Win64="yes" />

    <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.HyperlinkSidebarLicense">
      <bal:WixStandardBootstrapperApplication
        LicenseUrl=""
        LocalizationFile="..\Localization\mixxx_en-us.wxl"
        ThemeFile="bundletheme.xml"
        SuppressOptionsUI="no"
        ShowVersion="yes"
        LogoSideFile="build\wix\images\bundle-sidebar.png"
      />

<!-- LOCALIZATION -->
      <Payload Id="thm-ca-ES" Compressed="yes" Name="1027\thm.wxl" SourceFile="..\Localization\mixxx_ca-ES.wxl" />
      <Payload Id="thm-cs-CZ" Compressed="yes" Name="1029\thm.wxl" SourceFile="..\Localization\mixxx_cs-CZ.wxl" />
      <Payload Id="thm-de-DE" Compressed="yes" Name="1031\thm.wxl" SourceFile="..\Localization\mixxx_de-DE.wxl" />
      <Payload Id="thm-en-us" Compressed="yes" Name="1033\thm.wxl" SourceFile="..\Localization\mixxx_en-us.wxl" />
      <Payload Id="thm-es-ES" Compressed="yes" Name="1034\thm.wxl" SourceFile="..\Localization\mixxx_es-ES.wxl" />
      <Payload Id="thm-et-EE" Compressed="yes" Name="1061\thm.wxl" SourceFile="..\Localization\mixxx_et-EE.wxl" />
      <Payload Id="thm-fr-FR" Compressed="yes" Name="1036\thm.wxl" SourceFile="..\Localization\mixxx_fr-FR.wxl" />
      <Payload Id="thm-it-IT" Compressed="yes" Name="1040\thm.wxl" SourceFile="..\Localization\mixxx_it-IT.wxl" />
      <Payload Id="thm-nl-NL" Compressed="yes" Name="1043\thm.wxl" SourceFile="..\Localization\mixxx_nl-NL.wxl" />
      <Payload Id="thm-pl-PL" Compressed="yes" Name="1045\thm.wxl" SourceFile="..\Localization\mixxx_pl-PL.wxl" />
      <Payload Id="thm-pt-BR" Compressed="yes" Name="1046\thm.wxl" SourceFile="..\Localization\mixxx_pt-BR.wxl" />
      <Payload Id="thm-pt-PT" Compressed="yes" Name="2070\thm.wxl" SourceFile="..\Localization\mixxx_pt-PT.wxl" />
      <Payload Id="thm-ro-RO" Compressed="yes" Name="1048\thm.wxl" SourceFile="..\Localization\mixxx_ro-RO.wxl" />
      <Payload Id="thm-ru-RU" Compressed="yes" Name="1049\thm.wxl" SourceFile="..\Localization\mixxx_ru-RU.wxl" />
      <Payload Id="thm-sv-SE" Compressed="yes" Name="1053\thm.wxl" SourceFile="..\Localization\mixxx_sv-SE.wxl" />
      <Payload Id="thm-tr-TR" Compressed="yes" Name="1055\thm.wxl" SourceFile="..\Localization\mixxx_tr-TR.wxl" />
      <Payload Id="thm-zh-CN" Compressed="yes" Name="2052\thm.wxl" SourceFile="..\Localization\mixxx_zh-CN.wxl" />
      <Payload Id="thm-zh-TW" Compressed="yes" Name="1028\thm.wxl" SourceFile="..\Localization\mixxx_zh-TW.wxl" />
<!-- END LOCALIZATION -->

    </BootstrapperApplicationRef>

    <Variable Name="InstallFolder" Type="string" Value="[ProgramFiles6432Folder]Mixxx" />
    <Variable Name="LaunchTarget" Value="[InstallFolder]\mixxx.exe"/>

    <Chain DisableSystemRestore="yes">

      <!-- 32-bit / 64-bit variables -->
      <?if $(var.Platform) = x64 ?>
        <ExePackage
          Id="vcredist64"
          Name="Microsoft Visual C++ 2015 Redistributable (x64)"
          SourceFile="$(var.WINLIBPATH)\vc_redist.x64.exe"
          Cache="no"
          Compressed="yes"
          PerMachine="yes"
          Permanent="yes"
          Vital="yes"
          InstallCommand="/install /quiet /norestart"
          RepairCommand="/repair /quiet /norestart"
          UninstallCommand="/uninstall /quiet /norestart"
          DetectCondition="vcredist64installed">

          <!-- -->
          <ExitCode Value="3010" Behavior="forceReboot"/>

          <!-- Ignore "Newer version installed" error -->
          <ExitCode Value="1638" Behavior="success"/>
        </ExePackage>
      <?else ?>
        <ExePackage
          Id="vcredist"
          Name="Microsoft Visual C++ 2015 Redistributable (x86)"
          SourceFile="$(var.WINLIBPATH)\vc_redist.x86.exe"
          Cache="no"
          Compressed="yes"
          PerMachine="yes"
          Permanent="yes"
          Vital="yes"
          InstallCommand="/install /quiet /norestart"
          RepairCommand="/repair /quiet /norestart"
          UninstallCommand="/uninstall /quiet /norestart"
          DetectCondition="vcredist32installed">

          <!-- -->
          <ExitCode Value="3010" Behavior="forceReboot"/>

          <!-- Ignore "Newer version installed" error -->
          <ExitCode Value="1638" Behavior="success"/>
        </ExePackage>
      <?endif ?>

      <RollbackBoundary />

      <MsiPackage
        Id="MainPackage"
        SourceFile="$(var.MSIPackage)"
        DisplayInternalUI="yes"
        Compressed="yes"
        Vital="yes">
        <MsiProperty Name="INSTALLDIR" Value="[InstallFolder]" />
      </MsiPackage>

    </Chain>
  </Bundle>
</Wix>
